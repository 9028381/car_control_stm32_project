# control_car

为电赛控制题设计的一套硬件与软件，其中包括实现 pin2pin 兼容的 stm32 与 mspm0 核心板两块，集成底板一块以及对应的驱动代码
代码包括各类常用传感器的驱动代码以及运动控制代码，以及中间层实现对 stm32 库与 mspm0 库的兼容

项目的大体思路也写在这里吧

软件部分的结构如下

User
|
|--It 这里放置项目的所有中断回调函数
|
|--Middle 这里是想做一个中间层，把 stm32 与 mspm0 的库函数统一封装起来，因为我觉得 2025 年的电赛大概率不会限
| 制 ti 的芯片，所以这里可能会暂时搁置吧？
|
|--Sensor 这里放所有传感器的驱动代码，对传感器部分花了很多心思，想尽量写的优雅一点(后面细说吧)
|
|--Status 这里放小车的状态树，状态树上会挂载小车的所有状态，比如像运动状态、传感器数据、电机的状态等，小车所有
| 的状态都可以在这棵树上获取与更改(这里非常感谢@63,现在感觉确实是个好东西)
|
|--Tool 这里放置一些常用的工具例如 PID、数学方面的宏函数之类的

下面详细说一下传感器的部分：
首先是 delay 函数，想在单片机裸机里面优雅的实现 delay 函数真的不太容易，就算是 ST 官方的 HAL 库中的 delay 函数
使用不小心都会出现问题，稍微复杂一点的项目只要加上 delay 各种奇怪的问题都很可能出现(程序卡死、莫名其妙的逻辑错
误)，可能是因为 delay 嵌套调用什么的吧？现在我看见 delay 函数都感觉害怕，所以这个项目中我尽最大可能的避免使用
delay(目前好像还算顺利)，想避开 delay 不是特别容易，因为有些传感器的读取确实会消耗时间，之前为了包证一些传感器的
读取结束后再返回数据，所以在函数中经常会使用 delay，外加上小车可能需要同时用到很多传感器，每个传感器的读取消耗
2-3ms，加起来也是很长的一段时间。
为了解决上述的问题，我想了这么一个办法(现在想的挺好，希望实测的时候不要出问题 orz),办法就是把读取传感器数据与解析
传感器分开进行，并且使用 DMA 进行数据的读取操作，让 CPU 不用干等数据读取完毕。现在的想法是先把所有传感器的数据读取出
来，在传感器的驱动函数中读取传感器的函数分为以上两种 get_xxx_data()与 get_xxx_value(),get_data 就是进行读取操作，
get_value()是进行解析操作。我们定义一个定时器中断函数，假如是 25ms 一次吧，将定时器中断进行"二分频"就就是第一次进
中断进行 x 操作，第二次进中断进行 y 操作，第三次再进行 x 操作，第四次又是 y 操作，以此类推。现在我们将 get_data()类函数放
在 x 中，get_value()类函数放在 y 中，这样就达成了先进行 get_data()操作然后 25ms 后再进行 get_value()操作，并且 get_data()
全部使用 DMA 实现，所以所有读取传感器的操作可以并行，25ms 后所有传感器的数据肯定都读取完了(百分之一百，我没见过什么传
感器要读取超过 25ms 的)，然后进行 get_value()对传感器数据进行解析(解析是很快的，不会造成堵塞)，这样就巧妙的避开了
需要 delay 与传感器太多造成阻塞，负面影响就是所有传感器的数据会延时 25ms，应该察觉不到的，时间太短了，还有就是理解
可能难一点，但是经过上面的介绍应该可以明白吧。
传感器还有一类函数是 driver_xxx()，这类函数需要放在 while(1)或者特定的中断回调函数中，具体怎么用看注释。
传感器读取方面目前就想到了这些，先写到这里吧。

非常感谢@63，很多绝妙的想法使这个项目变得优雅，并且这个项目中也有很多代码是@63 所写，代码作者都标注在每个文件的第一行了
